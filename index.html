<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Learning App</title>
</head>

<body>

<div id="profile-screen">
    <h1>üìö English Learning</h1>
    <div id="profiles-list"></div>
    <button onclick="showCreateProfile()">‚ûï Create Profile</button>
</div>

<div id="main-app" style="display:none">
    <h2 id="current-profile-name"></h2>
    <button onclick="logout()">Logout</button>

    <h3>Add Word</h3>
    <form onsubmit="addWord(event)">
        <input id="word-input" placeholder="Word" required>
        <textarea id="word-meaning" placeholder="Meaning" required></textarea>
        <textarea id="word-example" placeholder="Example"></textarea>
        <button>Add</button>
    </form>

    <div id="words-list"></div>
</div>

<!-- CREATE PROFILE -->
<div id="create-profile" style="display:none">
    <input id="new-profile-name" placeholder="Profile Name">
    <input id="new-profile-pin" placeholder="4 Digit PIN" maxlength="4">
    <button onclick="createProfile()">Create</button>
</div>

<!-- PIN MODAL -->
<div id="pin-modal" style="display:none">
    <h3 id="pin-profile-name"></h3>
    <input id="enter-pin" maxlength="4">
    <button onclick="verifyPin()">Enter</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    getDoc,
    getDocs,
    deleteDoc,
    doc,
    onSnapshot,
    query,
    orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCt522OjKEuh7BMKoX2_yIvgy66dXs2DxI",
    authDomain: "english-learning-app-d6326.firebaseapp.com",
    projectId: "english-learning-app-d6326",
    storageBucket: "english-learning-app-d6326.firebasestorage.app",
    messagingSenderId: "80639036133",
    appId: "1:80639036133:web:f4284c24bb1ee95e7de20c",
    measurementId: "G-VVWYDWEK6R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.fs = {
    db,
    collection,
    addDoc,
    getDoc,
    getDocs,
    deleteDoc,
    doc,
    onSnapshot,
    query,
    orderBy
};
</script>

<script>
/* ======================
   GLOBAL STATE
====================== */
let currentProfile = null;
let selectedProfile = null;
let words = [];

/* ======================
   PROFILES (FIRESTORE)
====================== */

async function loadProfiles() {
    const snap = await fs.getDocs(fs.collection(fs.db, "profiles"));
    const list = document.getElementById("profiles-list");
    list.innerHTML = "";

    snap.forEach(d => {
        const p = d.data();
        list.innerHTML += `
            <button onclick="selectProfile('${d.id}','${p.name}')">
                üë§ ${p.name}
            </button>
        `;
    });
}

function showCreateProfile() {
    document.getElementById("create-profile").style.display = "block";
}

async function createProfile() {
    const name = new-profile-name.value.trim();
    const pin = new-profile-pin.value;

    if (!name || pin.length !== 4) {
        alert("Name and 4-digit PIN required");
        return;
    }

    await fs.addDoc(fs.collection(fs.db, "profiles"), {
        name,
        pin,
        createdAt: Date.now()
    });

    new-profile-name.value = "";
    new-profile-pin.value = "";
    create-profile.style.display = "none";
    loadProfiles();
}

function selectProfile(id, name) {
    selectedProfile = { id, name };
    pin-profile-name.textContent = name;
    pin-modal.style.display = "block";
}

async function verifyPin() {
    const enteredPin = enter-pin.value;
    const snap = await fs.getDoc(fs.doc(fs.db, "profiles", selectedProfile.id));

    if (!snap.exists() || snap.data().pin !== enteredPin) {
        alert("Incorrect PIN");
        return;
    }

    currentProfile = { id: selectedProfile.id, name: snap.data().name };
    pin-modal.style.display = "none";
    login();
}

function login() {
    profile-screen.style.display = "none";
    main-app.style.display = "block";
    current-profile-name.textContent = currentProfile.name;
    listenWords();
}

function logout() {
    currentProfile = null;
    main-app.style.display = "none";
    profile-screen.style.display = "block";
}

/* ======================
   WORDS (CODE 1 STYLE)
====================== */

function listenWords() {
    fs.onSnapshot(
        fs.query(
            fs.collection(fs.db, "profiles", currentProfile.id, "words"),
            fs.orderBy("timestamp", "desc")
        ),
        snap => {
            words = snap.docs.map(d => ({
                id: d.id,
                ...d.data()
            }));
            renderWords();
        }
    );
}

async function addWord(e) {
    e.preventDefault();

    await fs.addDoc(
        fs.collection(fs.db, "profiles", currentProfile.id, "words"),
        {
            word: word-input.value,
            meaning: word-meaning.value,
            example: word-example.value,
            date: new Date().toLocaleDateString(),
            timestamp: Date.now()
        }
    );

    e.target.reset();
}

async function deleteWord(id) {
    await fs.deleteDoc(
        fs.doc(fs.db, "profiles", currentProfile.id, "words", id)
    );
}

/* ======================
   UI
====================== */

function renderWords() {
    const list = document.getElementById("words-list");

    if (words.length === 0) {
        list.innerHTML = "No words yet";
        return;
    }

    list.innerHTML = words.map(w => `
        <div>
            <b>${w.word}</b> ‚Äì ${w.meaning}
            ${w.example ? `<div><i>${w.example}</i></div>` : ""}
            <button onclick="deleteWord('${w.id}')">üóëÔ∏è</button>
        </div>
        <hr>
    `).join("");
}

/* INIT */
loadProfiles();
</script>

</body>
</html>
