<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Learning App</title>
</head>

<body>

<div class="container">

<!-- PROFILE SCREEN -->
<div id="profile-screen">
    <h1>üìö English Learning</h1>
    <div id="profiles-list"></div>
    <button onclick="openCreateProfile()">‚ûï Create Profile</button>
</div>

<!-- MAIN APP -->
<div id="main-app" style="display:none">
    <h2 id="current-profile-name"></h2>
    <button onclick="logout()">Logout</button>

    <h3>Add Word</h3>
    <form onsubmit="addWord(event)">
        <input id="word-input" placeholder="Word" required>
        <textarea id="word-meaning" placeholder="Meaning" required></textarea>
        <textarea id="word-example" placeholder="Example"></textarea>
        <button>Add</button>
    </form>

    <div id="words-list"></div>
</div>

<!-- CREATE PROFILE MODAL -->
<div id="create-profile" style="display:none">
    <input id="new-name" placeholder="Profile Name">
    <input id="new-pin" placeholder="4 Digit PIN" maxlength="4">
    <button onclick="createProfile()">Create</button>
</div>

<!-- PIN MODAL -->
<div id="pin-modal" style="display:none">
    <h3 id="pin-name"></h3>
    <input id="pin-input" maxlength="4">
    <button onclick="verifyPin()">Enter</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCt522OjKEuh7BMKoX2_yIvgy66dXs2DxI",
  authDomain: "english-learning-app-d6326.firebaseapp.com",
  projectId: "english-learning-app-d6326",
  storageBucket: "english-learning-app-d6326.firebasestorage.app",
  messagingSenderId: "80639036133",
  appId: "1:80639036133:web:f4284c24bb1ee95e7de20c",
  measurementId: "G-VVWYDWEK6R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.fs = {
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  onSnapshot,
  query,
  orderBy,
  db
};
</script>

<script>
/* =======================
   GLOBAL STATE
======================= */
let currentProfile = null;
let selectedProfile = null;
let words = [];

/* =======================
   PROFILE (FIRESTORE)
======================= */

async function loadProfiles() {
    const snap = await fs.getDocs(fs.collection(fs.db, "profiles"));
    const list = document.getElementById("profiles-list");
    list.innerHTML = "";

    snap.forEach(docu => {
        const p = { id: docu.id, ...docu.data() };
        list.innerHTML += `
            <button onclick="selectProfile('${p.id}','${p.name}')">
                üë§ ${p.name}
            </button>
        `;
    });
}

function openCreateProfile() {
    document.getElementById("create-profile").style.display = "block";
}

async function createProfile() {
    const name = new-name.value.trim();
    const pin = new-pin.value;

    if (!name || pin.length !== 4) {
        alert("Name & 4-digit PIN required");
        return;
    }

    await fs.addDoc(fs.collection(fs.db, "profiles"), {
        name,
        pin,
        createdAt: Date.now()
    });

    new-name.value = "";
    new-pin.value = "";
    create-profile.style.display = "none";
    loadProfiles();
}

function selectProfile(id, name) {
    selectedProfile = { id, name };
    pin-name.textContent = name;
    pin-modal.style.display = "block";
}

async function verifyPin() {
    const entered = pin-input.value;
    const ref = fs.doc(fs.db, "profiles", selectedProfile.id);
    const snap = await fs.getDocs(fs.collection(ref, "dummy")); // force fetch
    const profileSnap = await fs.getDocs(fs.collection(fs.db, "profiles"));

    let correct = false;
    profileSnap.forEach(p => {
        if (p.id === selectedProfile.id && p.data().pin === entered) {
            correct = true;
        }
    });

    if (!correct) {
        alert("Wrong PIN");
        return;
    }

    currentProfile = selectedProfile;
    pin-modal.style.display = "none";
    login();
}

function login() {
    profile-screen.style.display = "none";
    main-app.style.display = "block";
    current-profile-name.textContent = currentProfile.name;
    listenWords();
}

function logout() {
    currentProfile = null;
    main-app.style.display = "none";
    profile-screen.style.display = "block";
}

/* =======================
   WORDS (FIRESTORE ‚Äì CODE 1 STYLE)
======================= */

function listenWords() {
    fs.onSnapshot(
        fs.query(
            fs.collection(fs.db, "profiles", currentProfile.id, "words"),
            fs.orderBy("timestamp", "desc")
        ),
        snap => {
            words = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderWords();
        }
    );
}

async function addWord(e) {
    e.preventDefault();

    await fs.addDoc(
        fs.collection(fs.db, "profiles", currentProfile.id, "words"),
        {
            word: word-input.value,
            meaning: word-meaning.value,
            example: word-example.value,
            date: new Date().toLocaleDateString(),
            timestamp: Date.now()
        }
    );

    e.target.reset();
}

async function deleteWord(id) {
    await fs.deleteDoc(
        fs.doc(fs.db, "profiles", currentProfile.id, "words", id)
    );
}

/* =======================
   UI
======================= */

function renderWords() {
    const list = document.getElementById("words-list");
    if (words.length === 0) {
        list.innerHTML = "No words yet";
        return;
    }

    list.innerHTML = words.map(w => `
        <div>
            <b>${w.word}</b> ‚Äî ${w.meaning}
            <button onclick="deleteWord('${w.id}')">üóëÔ∏è</button>
        </div>
    `).join("");
}

/* INIT */
loadProfiles();
</script>

</body>
</html>
